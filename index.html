<html>
  <head>
    <title>Phantachat</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
    <script>
      // on load of page
      $(function(){
        // var socket = io.connect('http://vast-anchorage-3166.herokuapp.com/');
        var socket = io.connect('http://phantachat.herokuapp.com/');

        // on connection to server, ask for user's name with an anonymous callback
        socket.on('connect', function(){
          // call the server-side function 'adduser' and send one parameter (value of prompt)
          myname = prompt("What's your name?");
          socket.emit('adduser', myname);
          $("#myid").html(myname);
        });

        var maxCharacters = 80;
        var counterMultiplier = 2;
        // Some char id that we will never use.
        var unusedCounterValue = 999999999;
        var fadeMillis = 1000;
        var timeoutMillis = 3000;
     
        // Username will be prepended to the messages sent for demuxing.
        // var username = prompt("Enter username:", "default") + ":";
        // $("#myid").text(username);

        var msg = $("#msg");
        var theirlog = $("#theirlog");
        var mylog = $("#mylog");
        var myCharCounter = 0;
        var theirCharCounter = 0;

        // Focus the text box.
        msg.focus();

        // Send message on keyup.
        msg.keyup(function() {
          var message = $(this).val();
          socket.emit('sendchat', message);
          $(this).val("");
        });

        // Text input box is always in focus.
        $(document).click(function() { msg.focus() });

        // listener, whenever the server emits 'updatechat', this updates the chat body
        socket.on('updatechat', function (username, data) {
          // Determine who the chat is coming from. Then update the right place.
          // Also put the fade on each character.
          if (data.length < 18 && data.indexOf("connected") == -1) {
            // console.log(myname);
            if (username == myname) {
              myCharCounter = getNextCharId(myCharCounter);
              appendLog(mylog, data, myCharCounter);
            } else {
              theirCharCounter = getNextCharId(theirCharCounter);
              appendLog($('#theirlog'), data, theirCharCounter);
            }
          } else {
            console.log(data);
          }

          // Strip the message header (username:) from the message.
          // var actualMessage = evt.data.substring(evt.data.indexOf(':') + 1);
          // if (isMyMessage(evt.data)) {
          //     myCharCounter = getNextCharId(myCharCounter);
          //     appendLog(mylog, actualMessage, myCharCounter); 
          // } else {
          //     theirCharCounter = getNextCharId(theirCharCounter);
          //     appendLog(theirlog, actualMessage, theirCharCounter); 
          // }
          // $('#conversation').append('<b>'+username + ':</b> ' + data + '<br>');
        });

        // listener, whenever the server emits 'updateusers', this updates the username list
        socket.on('updateusers', function(data) {
          // Add the user name to the appropriate .name element.

          $('#users').empty();
          $.each(data, function(key, value) {
            if (key != $("#myid").text()) {
              $("#theirid").text(key);
            }
            // $('#users').append('<div>' + key + '</div>');
          });
        });

        function getNextCharId(counter) {
          return (counter + 1) % (maxCharacters * counterMultiplier);
        }

        function appendLog(log, msg, charId) {
          var d = log[0]
          var doScroll = d.scrollTop == d.scrollHeight - d.clientHeight;

          // Add the fading span to the chat log.
          log.append("<span id='evaporate" + charId.toString() + "'>" + msg + "</span>");

          // Set timer to fade.
          setTimeout(function() {
            var localCharId = charId;
            $("#evaporate" + charId.toString()).animate({
              opacity: 0
            }, fadeMillis, function() {
              // Delete text if all characters have faded.
              if ((log == mylog && localCharId == myCharCounter) ||
                  (log == theirlog && localCharId == theirCharCounter)) {
                  log.empty();
              }
            });
          },
          timeoutMillis);

          if (doScroll) {
            d.scrollTop = d.scrollHeight - d.clientHeight;
          }

          // Delete from char queue if there are more than 20 characters.
          if (log.text().length > maxCharacters) {
            $(":first-child", log).remove();
          };
        }

        // // when the client clicks SEND
        // $('#datasend').click( function() {
        //   var message = $('#data').val();
        //   $('#data').val('');
        //   // tell server to execute 'sendchat' and send along one parameter
        //   socket.emit('sendchat', message);
        // });

        // when the client hits ENTER on their keyboard
        // $('#data').keypress(function(e) {
        //   if(e.which == 13) {
        //     $(this).blur();
        //     $('#datasend').focus().click();
        //   }
        // });
      });
    </script>
    <style type="text/css">
      html {
          overflow: hidden;
          font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      }
       
      body {
          overflow: hidden;
          padding: 0;
          margin: 0;
          width: 100%;
          height: 100%;
          background: white;
      }

      .log {
          margin: 0;
          border-style: solid;
          border-color: white;
          border-width: 50px;
          background: white;
          padding-right: 20%;
          padding-left: 20%;
          text-align: right;
          font-size: 3.6em;
          height: 30%;
      }

      .name {
          position: relative;
          left: 20%;
          top: 40px;
          text-align: right;
          color: #919191;
      }

      #form {
          padding: 0;
          margin: 0;
          position: absolute;
          bottom: 1em;
          left: 0px;
          width: 100%;
          overflow: hidden;
      }

      #msg {
          border: none;
          position: absolute;
          right: 0px;
          bottom: 0px;
          opacity: 0;
          padding: 0px;
          text-align: right;
          width: 10%;
      }

      #msg:focus{
          outline: none;
      }

      #fade {
          margin-right: 5em;
          text-align: right;
      }
    </style>
  </head>
  <body>
    <!-- <div style="float:left;width:100px;border-right:1px solid black;height:300px;padding:10px;overflow:scroll-y;">
      <b>USERS</b>
      <div id="users"></div>
    </div> -->
    <!-- <div style="float:left;width:300px;height:250px;overflow:scroll-y;padding:10px;">
      <div id="conversation"></div>
      <input id="data" style="width:200px;" />
      <input type="button" id="datasend" value="send" />
    </div> -->

    <div class="logcontainer">
        <span id="theirid" class="name"></span>
        <div id="theirlog" class="log"></div>
    </div>
    <div class="logcontainer">
        <span id="myid" class="name"></span>
        <div id="mylog" class="log"></div>
    </div>
    <input type="text" id="msg" size="64"/>
  </body>
</html>